name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Login to DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4️⃣ Cache detection for backend
      - name: Check if backend changed
        id: backend_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/ci-cd.yml'

      # 5️⃣ Cache detection for frontend
      - name: Check if frontend changed
        id: frontend_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/ci-cd.yml'

      # 6️⃣ Build and push backend image if backend files changed
      - name: Build & Push Backend Image
        if: steps.backend_changes.outputs.backend == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/myapp-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/myapp-backend:cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/myapp-backend:cache,mode=max

      # 7️⃣ Build and push frontend image if frontend files changed
      - name: Build & Push Frontend Image
        if: steps.frontend_changes.outputs.frontend == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/myapp-frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/myapp-frontend:cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/myapp-frontend:cache,mode=max

      # 8️⃣ Verify build (optional sanity check)
      - name: Test docker compose build
        run: |
          docker compose -f docker-compose.yml config
          echo "✅ Compose configuration validated successfully"
